version: "3.9"
services:
  mongo:
    image: mongo:6
    container_name: mongo
    ports: ["27017:27017"]
    command: ["--replSet","rs0","--bind_ip_all"]
    volumes:
      - mongo_data:/data/db
    healthcheck:
      test: ["CMD","mongosh","--eval","db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 20

  zookeeper:
    # Use the official Zookeeper image since the Bitnami 3.9 manifest is missing on the registry.
    image: zookeeper:3.9
    environment: { ALLOW_ANONYMOUS_LOGIN: "yes" }
    ports: ["2181:2181"]

  kafka:
    # Use Confluent Community Platform Kafka image which is widely available on Docker Hub.
    # This replaces Bitnami image because Bitnami Kafka tags are missing in the registry for your environment.
    image: confluentinc/cp-kafka:7.4.0
    depends_on: [zookeeper]
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # Listen on all interfaces inside container
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      # Advertise the container name and standard port so other services in the compose network can reach it
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      # Reduce replication requirements for single-node dev environment
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
    ports: ["9092:9092"]

  spark:
    image: apache/spark:3.5.1
    environment: { SPARK_MODE: master }
    ports: ["7077:7077","8080:8080"]

  spark-worker:
    image: apache/spark:3.5.1
    environment:
      SPARK_MODE: worker
      SPARK_MASTER_URL: spark://spark:7077
    depends_on: [spark]

  api:
    build: ./api
    container_name: api
    ports: ["8000:8000"]
    environment:
      MONGO_URI: mongodb://mongo:27017/?replicaSet=rs0
      KAFKA_BOOTSTRAP: kafka:9092
      INFER_URL: http://phobert-infer:5000/predict
    depends_on: [mongo, kafka]

  phobert-infer:
    build: ./phobert-infer
    container_name: phobert-infer
    ports: ["9000:5000"]
    environment:
      MODEL_ID: wonrax/phobert-base-vietnamese-sentiment
      DEVICE: cuda
    # Use deploy.resources syntax for GPU in Compose v2+
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  spark-job:
    build: ./spark-job
    depends_on: [kafka, mongo]
    environment:
      KAFKA_BOOTSTRAP: kafka:9092
      MONGO_URI: mongodb://mongo:27017/?replicaSet=rs0
      SPARK_MASTER: local[*]

  phobert-consumer:
    build: ./phobert-consumer
    container_name: phobert-consumer
    environment:
      KAFKA_BOOTSTRAP: realtime-vn-sentiment-kafka-1:9092
      KAFKA_TOPIC: reviews
      MONGO_URI: mongodb://mongo:27017/?replicaSet=rs0
      INFER_URL: http://phobert-infer:5000/predict
      BATCH_SIZE: "128"
      MAX_LATENCY_MS: "1500"
    depends_on: [kafka, phobert-infer, mongo]

  crawler-html:
    build: ./crawler-html
    container_name: crawler-html
    environment:
      MONGO_URI: mongodb://mongo:27017/?replicaSet=rs0
      HEADLESS: "1"
      RATE_PER_MIN: "60"
      PROXY_LIST: ""
    depends_on: [mongo]

  ui:
    build: ./ui
    container_name: ui
    ports: ["8501:8501"]
    environment:
      API_BASE: http://api:8000
      MONGO_URI: mongodb://mongo:27017/?replicaSet=rs0
      INFER_URL: http://phobert-infer:5000
    depends_on: [api, mongo, phobert-infer]

volumes:
  mongo_data:
